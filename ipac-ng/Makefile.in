# $Id: Makefile.in,v 1.8 2004/06/14 23:37:57 friedl Exp $
SUBSTFILES=ipacsum fetchipac.8 ipacsum.8 ipac-convert.8
SHFILES=ipacsum ipac-convert ipactest
ELFFILES=fetchipac
INSTFILES=fetchipac ipacsum ipac-convert
STRIP_EXT=inst
MANFILES=fetchipac.8 ipacsum.8 ipac-convert.8
CC=@CC@
DESTDIR = 
YACC=@YACC@
LEX=@LEX@
CFLAGS=@CFLAGS@
LDFLAGS=@LDFLAGS@
LIBS=@LIBS@
DEFS=@DEFS@
srcdir=@srcdir@
prefix=@prefix@
exec_prefix=@exec_prefix@
PERL=@PERL@

INSTALLPATH=@sbindir@
IMANPATH=@mandir@/man8
ACCTDIR=@ipac_datadir@
STRIP_DEBUG=yes
STORAGEMETHODS=@STORAGEMETHODS@
ACCAGENTS=@ACCAGENTS@
BILLAGENTS=@BILLAGENTS@
STORAGEMETHODLIBRARYS=@STORAGEMETHODLIBRARYS@
ACCAGENTSLIBRARYS=@ACCAGENTSLIBRARYS@
BILLAGENTSLIBRARYS=@BILLAGENTSLIBRARYS@

# add this to DEFS since we cant get autoconf to put it into config.h
DEFS+=-DINSTALLPATH=\"${INSTALLPATH}\"

all: dosubst all-recursive $(ELFFILES)

dosubst: subst subst-config $(SUBSTFILES)
	@echo "running subst on files: $(SUBSTFILES)..."
	@for file in $(SUBSTFILES); do \
		./subst -f subst-config $$file || exit 1; \
	done
	chmod +x $(SHFILES)
	touch dosubst

dbstrip: $(SHFILES) $(ELFFILES)
	@echo -n "stripping debug code... "
	@for file in $(SHFILES); do 				\
		if [ "$(STRIP_DEBUG)" = "yes" ]; then 		\
			awk '					\
				BEGIN {db=0} 			\
				/^#@ DEBUG CODE BEGIN/ {db=1}	\
				db==0 {print}			\
				/^#@ DEBUG CODE END/ {db=0}	\
				' <$$file >$$file.$(STRIP_EXT); \
		else						\
			cp $$file $$file.$(STRIP_EXT);		\
		fi;						\
		chmod +x $$file.$(STRIP_EXT); 			\
		echo -n "$$file ";				\
	done
	@for file in $(ELFFILES); do				\
		if [ "$(STRIP_DEBUG)" = "yes" ]; then		\
			strip $$file;				\
		fi;						\
		echo -n "$$file ";				\
	done
	@echo "done."



# subst may have changed Makefile!
install: all @DBSTRIP@
	make doinstall

doinstall: install-bin install-man

install-bin:
	./mkinstalldirs $(DESTDIR)$(INSTALLPATH)
	./mkinstalldirs $(DESTDIR)$(ACCTDIR)
	@for file in $(INSTFILES); do 				\
		SFILE="$$file.$(STRIP_EXT)";			\
		test -f $$SFILE || SFILE=$$file;			\
		echo "install -m 755 $$SFILE $(DESTDIR)$(INSTALLPATH)/$$file"; \
		install -m 755 $$SFILE $(DESTDIR)$(INSTALLPATH)/$$file || exit 1; \
	done

install-man:
	./mkinstalldirs $(DESTDIR)$(IMANPATH)
	@for file in $(MANFILES); do \
		echo "install -m 644 $$file $(DESTDIR)$(IMANPATH)/$$file"; \
		install -m 644 $$file $(DESTDIR)$(IMANPATH)/$$file || exit 1; \
	done
	

subst: subst.c
	$(CC) $(CFLAGS) -o subst subst.c

fetchipac: fetchipac.o storagetable.o billtable.o agenttable.o batch.tab.o libipac.a batch.yy.o\
		     conffile.tab.o conffile.yy.o\
		$(STORAGEMETHODLIBRARYS) $(ACCAGENTSLIBRARYS) $(BILLAGENTSLIBRARYS)
	$(CC) $(LDFLAGS) -rdynamic fetchipac.o storagetable.o agenttable.o \
			billtable.o batch.tab.o batch.yy.o conffile.tab.o conffile.yy.o\
			${LIBS} -o fetchipac

ipacd: ipacd.o libipq.o libipac.a
	$(CC) $(LDFLAGS) libipq.o ipacd.o ${LIBS} -o ipacd

all-recursive clean-recursive distclean-recursive maintainerclean-recursive:
	@for subdir in storage agents access; do \
		target=`echo $@ | sed s/-recursive//`; \
		echo "Making $$target in $$subdir"; \
		(cd $$subdir && $(MAKE) $$target) || exit 1; \
	done

%.o : %.c ipac.h config.h
	$(CC) -c $(DEFS) $(CFLAGS) $< -o $@

conffile.yy.c: conffile.l conffile.tab.c
	$(LEX) -oconffile.yy.c -Pconf conffile.l

batch.yy.c: batch.l batch.tab.c
	$(LEX) -obatch.yy.c batch.l

conffile.tab.c: conffile.y
	$(YACC) -d -b conffile -p conf conffile.y

batch.tab.c: batch.y
	$(YACC) -d -b batch batch.y

libipac.a: lock.o rule.o xmalloc.o
	ar -crus libipac.a $?

storagetable.c: Makefile
	@echo "creating $@..."
	@echo "/* this file is automatically generated, do not edit */" >$@
	@echo "#include \"ipac.h\"" >>$@
	@rm -f $@.end
	@for smt in $(STORAGEMETHODS); do \
		sm=`echo $$smt | sed -e 's/-/_/g'`; \
		echo "const storage_method_t *ipac_sm_interface_$$sm();" >>$@; \
		echo "  ipac_sm_interface_$$sm," >>$@.end; \
	done
	@echo "const storage_method_t *(*storage_method_if[])() = {" >>$@
	@cat $@.end >> $@
	@echo "  NULL" >>$@
	@echo "};" >>$@
	@rm -f $@.end

agenttable.c: Makefile
	@echo "creating $@..."
	@echo "/* this file is automatically generated, do not edit */" >$@
	@echo "#include \"ipac.h\"" >>$@
	@rm -f $@.end
	@for smt in $(ACCAGENTS); do \
		sm=`echo $$smt | sed -e 's/-/_/g'`; \
		echo "const acc_agent_t *ipac_ag_interface_$$sm();" >>$@; \
		echo "  ipac_ag_interface_$$sm," >>$@.end; \
	done
	@echo "const acc_agent_t *(*acc_agent_if[])() = {" >>$@
	@cat $@.end >> $@
	@echo "  NULL" >>$@
	@echo "};" >>$@
	@rm -f $@.end

billtable.c: Makefile
	@echo "creating $@..."
	@echo "/* this file is automatically generated, do not edit */" >$@
	@echo "#include \"ipac.h\"" >>$@
	@rm -f $@.end
	@for smt in $(BILLAGENTS); do \
		sm=`echo $$smt | sed -e 's/-/_/g'`; \
		echo "const access_agent_t *ipac_ac_interface_$$sm();" >>$@; \
		echo "  ipac_ac_interface_$$sm," >>$@.end; \
	done
	@echo "const access_agent_t *(*access_agent_if[])() = {" >>$@
	@cat $@.end >> $@
	@echo "  NULL" >>$@
	@echo "};" >>$@
	@rm -f $@.end


clean: clean-recursive
	rm -f subst dosubst *.o libipac.a lib/*.o billtable.c conffile.tab.* conffile.yy.*\
		fetchipac storagetable.c agenttable.c batch.tab.c batch.tab.* batch.yy.c ipacd
	@for file in $(INSTFILES); do			\
		echo "rm -f $$file.$(STRIP_EXT)";	\
		rm -f $$file.$(STRIP_EXT);		\
	done
	rm -f ipac-convert.inst ipactest.inst

distclean: clean distclean-recursive
	rm -f Makefile config.h config.status config.cache config.log \
		subst-config ipactest fetchipac
	rm -fr autom4te.cache *~ *.orig

maintainerclean: distclean
	rm -f configure config.h.in stamp-h.in

test_gdbm: gdbm.c ipac_gdbm.h ipac.h libipac.a
	$(CC) $(CFLAGS) -DTEST_GDBM gdbm.c $(LDFLAGS) -o test_gdbm

${srcdir}/configure: configure.in aclocal.m4
	cd ${srcdir} && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
${srcdir}/config.h.in: stamp-h.in

${srcdir}/stamp-h.in: configure.in aclocal.m4 acconfig.h
	cd ${srcdir} && autoheader
	echo timestamp > ${srcdir}/stamp-h.in

# test tests fetchipac
test: fetchipac
	@echo "Making tests. Creating data file..."
	@mkdir $(srcdir)/test.data

	@for sm in $(STORAGEMETHODS); do \
		echo "  
		
test.data:
	@echo -n "Creating test data file..."
	@perl -e 
